# Assumindo que o seu DockerHub Username é seuuserdockerhub...

# Lembre-se de configurar os seguintes secrets no GitHub:
# DOCKER_USERNAME
# DOCKER_PASSWORD
# GH_TOKEN (Personal Access Token com permissões de escrita no repositório, para o passo de GitOps/commit automático)
name: Pipeline CI/CD com GitOps (Backend, Simulator, Frontend)

on:
  push:
    branches:
      - main
    # Só executa a pipeline se houver alteração em qualquer uma destas pastas
    paths:
      - 'backend/**'
      - 'simulator/**'
      - 'frontend/**'
      - 'k8s/**'

jobs:
  # =================================================================
  # JOB 1: BACKEND (Consumidor/API)
  # =================================================================
  build_backend:
    runs-on: ubuntu-latest
    # Corre apenas se houver alterações na pasta 'backend' ou se o commit for a primeira vez
    if: |
      contains(github.event.commits[0].modified, 'backend') || 
      contains(github.event.commits[0].added, 'backend') ||
      contains(github.event.head_commit.message, 'Initial commit')
    
    steps:
      - name: 1. Checkout do Código (Permitir push)
        uses: actions/checkout@v4
        with:
          # Usar o PAT (GH_TOKEN) para que o bot possa fazer o commit de volta
          token: ${{ secrets.GH_TOKEN }} 

      - name: 2. Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: 3. Definir Variáveis e Tag
        id: vars
        run: echo "TAG=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
      
      - name: 4. Build e Push da Imagem do Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/backend:${{ steps.vars.outputs.TAG }}

      # --- Fase CD (GitOps) ---
      - name: 5. Instalar yq (ferramenta para editar YAML)
        run: sudo apt-get update && sudo apt-get install -y yq

      - name: 6. Atualizar a Tag no Manifesto Kubernetes do Backend
        run: |
          yq e '.spec.template.spec.containers[0].image = "${{ secrets.DOCKER_USERNAME }}/backend:${{ steps.vars.outputs.TAG }}"' -i k8s/backend/deployment.yaml
          
      - name: 7. Commit e Push do Manifesto Atualizado (Gatilho para ArgoCD)
        run: |
          git config user.name "GitHub Actions Bot (GitOps)"
          git config user.email "actions@github.com"
          git add k8s/backend/deployment.yaml
          git commit -m "chore(cd): :rocket: Update backend image to ${{ steps.vars.outputs.TAG }}" || echo "No changes to commit"
          # Autenticação via HTTPS usando o GH_TOKEN
          git push

  # =================================================================
  # JOB 2: SIMULATOR (Produtor)
  # =================================================================
  build_simulator:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.commits[0].modified, 'simulator') || 
      contains(github.event.commits[0].added, 'simulator')
      
    steps:
      - name: 1. Checkout do Código
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }} 

      - name: 2. Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: 3. Definir Variáveis e Tag
        id: vars
        run: echo "TAG=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
      
      - name: 4. Build e Push da Imagem do Simulator
        uses: docker/build-push-action@v5
        with:
          context: ./simulator
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/simulator:${{ steps.vars.outputs.TAG }}

      - name: 5. Instalar yq (ferramenta para editar YAML)
        run: sudo apt-get update && sudo apt-get install -y yq

      - name: 6. Atualizar a Tag no Manifesto Kubernetes do Simulator
        run: |
          yq e '.spec.template.spec.containers[0].image = "${{ secrets.DOCKER_USERNAME }}/simulator:${{ steps.vars.outputs.TAG }}"' -i k8s/simulator/deployment.yaml
          
      - name: 7. Commit e Push do Manifesto Atualizado
        run: |
          git config user.name "GitHub Actions Bot (GitOps)"
          git config user.email "actions@github.com"
          git add k8s/simulator/deployment.yaml
          git commit -m "chore(cd): :rocket: Update simulator image to ${{ steps.vars.outputs.TAG }}" || echo "No changes to commit"
          git push

  # =================================================================
  # JOB 3: FRONTEND (UI)
  # =================================================================
  build_frontend:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.commits[0].modified, 'frontend') || 
      contains(github.event.commits[0].added, 'frontend')

    steps:
      - name: 1. Checkout do Código
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }} 

      - name: 2. Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: 3. Definir Variáveis e Tag
        id: vars
        run: echo "TAG=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
      
      - name: 4. Build e Push da Imagem do Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/frontend:${{ steps.vars.outputs.TAG }}

      - name: 5. Instalar yq (ferramenta para editar YAML)
        run: sudo apt-get update && sudo apt-get install -y yq

      - name: 6. Atualizar a Tag no Manifesto Kubernetes do Frontend
        run: |
          yq e '.spec.template.spec.containers[0].image = "${{ secrets.DOCKER_USERNAME }}/frontend:${{ steps.vars.outputs.TAG }}"' -i k8s/frontend/deployment.yaml
          
      - name: 7. Commit e Push do Manifesto Atualizado
        run: |
          git config user.name "GitHub Actions Bot (GitOps)"
          git config user.email "actions@github.com"
          git add k8s/frontend/deployment.yaml
          git commit -m "chore(cd): :rocket: Update frontend image to ${{ steps.vars.outputs.TAG }}" || echo "No changes to commit"
          git push